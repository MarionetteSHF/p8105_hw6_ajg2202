---
title: "p8105_hw6_hs3239"
author: "hanfu shi"
date: "2021/11/23"
output: github_document
---

```{r setup}
library(tidyverse)
library(dplyr)
library(readxl)
library(ggplot2)
library(p8105.datasets)
library(modelr)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

## problem 1
```{r}
birthweight_df = 
  read_csv("data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  ) %>% 
  view
birthweight_df
purrr::map(birthweight_df, ~ sum(is.na(.)))

```
This dataset contains `r nrow(birthweight_df)` rows and `r ncol(birthweight_df)` columns, there is no missing data.

For the regression model, I chose several hypothesized variables that I believe may affect birthright along with variables that have be determined from previous research and literature.

Wikipedia indicate that young ages, multiple pregnancies (parity), and previous LBW infants are several risk factors in the mother that contribute to low birth weight. Mother's age, parity and previous number of low birthweight infants are chosen for the model.

Gestational weeks and presence of malformations appear to be an logical indicator of birthweight and was included in the model as such. 

I was also interested in whether several socialdemographic factors would affect birthweight, so I included factors such as mom's race and financial income.

#Regression model and residual plot
```{r}
model_fit_1 = lm(bwt ~ gaweeks + momage + mrace + malform + parity + fincome + pnumlbw, data = birthweight_df)

birthweight_df %>% 
  modelr::add_residuals(model_fit_1) %>%
  modelr::add_predictions(model_fit_1) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = 0.3) +
  geom_smooth(se = F, color = "red", method = "lm")
  labs(
    title = "Predicted vs. Residuals",
    x = "Predicted",
    y = "Residuals"
    ) +
  theme(plot.title = element_text(hjust = 0.5))
```


#Other model
```{r model_building}
model_2 = lm(bwt ~ gaweeks + blength, data = birthweight_df)
model_3 = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = birthweight_df)
```

## Cross validation

```{r cv_df, warning=FALSE}
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
cv_df = 
  cv_df %>% 
  mutate(
   model_fit_1 = map(.x = train, ~lm(bwt ~ gaweeks + momage + mrace + malform + parity + fincome + pnumlbw, data = .x)),
   model_2 = map(.x = train, ~lm(bwt ~ gaweeks + blength, data = .x)),
   model_3 = map(.x = train, ~lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = .x))
  ) %>% 
  mutate(
    rmse_model1 = map2_dbl(.x = model_fit_1, .y = test, ~rmse(model = .x, data = .y)),
    rmse_model2 = map2_dbl(.x = model_2, .y = test, ~rmse(model = .x, data = .y)),
    rmse_model3 = map2_dbl(.x = model_3, .y = test, ~rmse(model = .x, data = .y))
  )

```

### Violin plot of RMSEs

```{r violin_plot}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_violin()
```

From the RMSE plot, it appears that of the 3 models, model 3 is the best fit as it has the lowest RSME. The model 1  was a poor fit for the data.

Model 3 contains head circumference, length, sex, and all interactions (including the three-way interaction) between these.

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```



```{r}
set.seed(2222)
boot_sample = function(df) {
  sample_frac(df, replace = TRUE)
}

```

```{r}
boot_straps = 
  data_frame(
    strap_number = 1:5000,
    strap_sample = rerun(5000, boot_sample(weather_df))
  )
boot_results = 
  boot_straps %>% 
  mutate(
    models = map(.x = strap_sample, ~lm(tmax ~ tmin, data = .x)), 
    results = map(models, broom::glance)
  ) %>%
  select(strap_number, results) %>% 
  unnest(results)


```
### R-Squared

```{r r_squared}
boot_results %>%
  ggplot(aes(x = adj.r.squared)) +
  geom_density() +
  labs(
        title = "Distribution of R Squared",
        x = "R Squared"
    ) +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}



```


```{r}


```


